import cirq

import cirq_qubitization


def test_expand_composite_and_allocate_qubits():
    data = [[1, 2, 3, 1, 2, 3], [4, 5, 6, 4, 5, 6]]
    blocksize = 2
    qrom = cirq_qubitization.SelectSwapQROM(*data, block_size=blocksize)
    op = qrom.on_registers(**qrom.registers.get_named_qubits())
    extra_q = cirq.GridQubit.rect(1, 4)
    cirq_qubitization.qalloc_reset()
    circuit = cirq.Circuit(
        cirq.X.on_each(*extra_q),
        cirq.Moment(op),
        cirq.Moment(cirq.X.on_each(*extra_q)),
        cirq.Circuit(cirq.decompose_once(op)),
    )

    # Original circuit
    cirq.testing.assert_has_diagram(
        circuit,
        """
                                                   ┌─────┐                                 ┌─────┐
_b0: ────────────────────────────QROM_0───swap_0────@────────swap_0──────QROM_0───swap_0────@────────swap_0──────
                                 │        │         │        │           │        │         │        │
_b1: ────────────────────────────QROM_0───swap_0────┼@───────swap_0──────QROM_0───swap_0────┼@───────swap_0──────
                                 │        │         ││       │           │        │         ││       │
_b2: ────────────────────────────QROM_1───swap_0────┼┼@──────swap_0──────QROM_1───swap_0────┼┼@──────swap_0──────
                                 │        │         │││      │           │        │         │││      │
_b3: ────────────────────────────QROM_1───swap_0────┼┼┼@─────swap_0──────QROM_1───swap_0────┼┼┼@─────swap_0──────
                                 │        │         ││││     │           │        │         ││││     │
_b4: ────────────────────────────QROM_1───swap_0────┼┼┼┼@────swap_0──────QROM_1───swap_0────┼┼┼┼@────swap_0──────
                                 │        │         │││││    │           │        │         │││││    │
_b5: ────────────────────────────QROM_2───swap_1────┼┼┼┼┼────swap_1──────QROM_2───swap_1────┼┼┼┼┼────swap_1──────
                                 │        │         │││││    │           │        │         │││││    │
_b6: ────────────────────────────QROM_2───swap_1────┼┼┼┼┼────swap_1──────QROM_2───swap_1────┼┼┼┼┼────swap_1──────
                                 │        │         │││││    │           │        │         │││││    │
_b7: ────────────────────────────QROM_3───swap_1────┼┼┼┼┼────swap_1──────QROM_3───swap_1────┼┼┼┼┼────swap_1──────
                                 │        │         │││││    │           │        │         │││││    │
_b8: ────────────────────────────QROM_3───swap_1────┼┼┼┼┼────swap_1──────QROM_3───swap_1────┼┼┼┼┼────swap_1──────
                                 │        │         │││││    │           │        │         │││││    │
_b9: ────────────────────────────QROM_3───swap_1────┼┼┼┼┼────swap_1──────QROM_3───swap_1────┼┼┼┼┼────swap_1──────
                                 │        │         │││││    │           │        │         │││││    │
(0, 0): ───────X─────────────X───┼────────┼─────────┼┼┼┼┼────┼───────────┼────────┼─────────┼┼┼┼┼────┼───────────
                                 │        │         │││││    │           │        │         │││││    │
(0, 1): ───────X─────────────X───┼────────┼─────────┼┼┼┼┼────┼───────────┼────────┼─────────┼┼┼┼┼────┼───────────
                                 │        │         │││││    │           │        │         │││││    │
(0, 2): ───────X─────────────X───┼────────┼─────────┼┼┼┼┼────┼───────────┼────────┼─────────┼┼┼┼┼────┼───────────
                                 │        │         │││││    │           │        │         │││││    │
(0, 3): ───────X─────────────X───┼────────┼─────────┼┼┼┼┼────┼───────────┼────────┼─────────┼┼┼┼┼────┼───────────
                                 │        │         │││││    │           │        │         │││││    │
selection0: ───────In_q──────────In───────┼─────────┼┼┼┼┼────┼───────────In───────┼─────────┼┼┼┼┼────┼───────────
                   │             │        │         │││││    │           │        │         │││││    │
selection1: ───────In_q──────────In───────┼─────────┼┼┼┼┼────┼───────────In^-1────┼─────────┼┼┼┼┼────┼───────────
                   │                      │         │││││    │                    │         │││││    │
selection2: ───────In_r───────────────────@(r⇋0)────┼┼┼┼┼────@(r⇋0)^-1────────────@(r⇋0)────┼┼┼┼┼────@(r⇋0)^-1───
                   │                                │││││                                   │││││
target00: ─────────QROAM_0──────────────────────────X┼┼┼┼───────────────────────────────────X┼┼┼┼────────────────
                   │                                 ││││                                    ││││
target01: ─────────QROAM_0───────────────────────────X┼┼┼────────────────────────────────────X┼┼┼────────────────
                   │                                  │││                                     │││
target10: ─────────QROAM_1────────────────────────────X┼┼─────────────────────────────────────X┼┼────────────────
                   │                                   ││                                      ││
target11: ─────────QROAM_1─────────────────────────────X┼──────────────────────────────────────X┼────────────────
                   │                                    │                                       │
target12: ─────────QROAM_1──────────────────────────────X───────────────────────────────────────X────────────────
                                                   └─────┘                                 └─────┘
    """,
    )

    # Don't decompose, only do qubit assignment.
    cirq.testing.assert_has_diagram(
        cirq_qubitization.expand_composite_and_allocate_qubits(circuit, decompose=lambda op: op),
        """
                                                   ┌─────┐                                 ┌─────┐
(0, 0): ───────X─────────────X───QROM_0───swap_0────@────────swap_0──────QROM_0───swap_0────@────────swap_0──────
                                 │        │         │        │           │        │         │        │
(0, 1): ───────X─────────────X───QROM_0───swap_0────┼@───────swap_0──────QROM_0───swap_0────┼@───────swap_0──────
                                 │        │         ││       │           │        │         ││       │
(0, 2): ───────X─────────────X───QROM_1───swap_0────┼┼@──────swap_0──────QROM_1───swap_0────┼┼@──────swap_0──────
                                 │        │         │││      │           │        │         │││      │
(0, 3): ───────X─────────────X───QROM_1───swap_0────┼┼┼@─────swap_0──────QROM_1───swap_0────┼┼┼@─────swap_0──────
                                 │        │         ││││     │           │        │         ││││     │
ancilla_0: ──────────────────────QROM_1───swap_0────┼┼┼┼@────swap_0──────QROM_1───swap_0────┼┼┼┼@────swap_0──────
                                 │        │         │││││    │           │        │         │││││    │
ancilla_1: ──────────────────────QROM_2───swap_1────┼┼┼┼┼────swap_1──────QROM_2───swap_1────┼┼┼┼┼────swap_1──────
                                 │        │         │││││    │           │        │         │││││    │
ancilla_2: ──────────────────────QROM_2───swap_1────┼┼┼┼┼────swap_1──────QROM_2───swap_1────┼┼┼┼┼────swap_1──────
                                 │        │         │││││    │           │        │         │││││    │
ancilla_3: ──────────────────────QROM_3───swap_1────┼┼┼┼┼────swap_1──────QROM_3───swap_1────┼┼┼┼┼────swap_1──────
                                 │        │         │││││    │           │        │         │││││    │
ancilla_4: ──────────────────────QROM_3───swap_1────┼┼┼┼┼────swap_1──────QROM_3───swap_1────┼┼┼┼┼────swap_1──────
                                 │        │         │││││    │           │        │         │││││    │
ancilla_5: ──────────────────────QROM_3───swap_1────┼┼┼┼┼────swap_1──────QROM_3───swap_1────┼┼┼┼┼────swap_1──────
                                 │        │         │││││    │           │        │         │││││    │
selection0: ───────In_q──────────In───────┼─────────┼┼┼┼┼────┼───────────In───────┼─────────┼┼┼┼┼────┼───────────
                   │             │        │         │││││    │           │        │         │││││    │
selection1: ───────In_q──────────In───────┼─────────┼┼┼┼┼────┼───────────In^-1────┼─────────┼┼┼┼┼────┼───────────
                   │                      │         │││││    │                    │         │││││    │
selection2: ───────In_r───────────────────@(r⇋0)────┼┼┼┼┼────@(r⇋0)^-1────────────@(r⇋0)────┼┼┼┼┼────@(r⇋0)^-1───
                   │                                │││││                                   │││││
target00: ─────────QROAM_0──────────────────────────X┼┼┼┼───────────────────────────────────X┼┼┼┼────────────────
                   │                                 ││││                                    ││││
target01: ─────────QROAM_0───────────────────────────X┼┼┼────────────────────────────────────X┼┼┼────────────────
                   │                                  │││                                     │││
target10: ─────────QROAM_1────────────────────────────X┼┼─────────────────────────────────────X┼┼────────────────
                   │                                   ││                                      ││
target11: ─────────QROAM_1─────────────────────────────X┼──────────────────────────────────────X┼────────────────
                   │                                    │                                       │
target12: ─────────QROAM_1──────────────────────────────X───────────────────────────────────────X────────────────
                                                   └─────┘                                 └─────┘
    """,
    )

    return

    # Decompose the composite operation and also do qubit assignment.
    def decompose_func(op):
        return (
            cirq.decompose_once(op) if isinstance(op.gate, cirq_qubitization.SelectSwapQROM) else op
        )

    # TODO: The qubit allocation for borrwed qubits is not stable right now, so this test fails. Fix it.
    cirq.testing.assert_has_diagram(
        cirq_qubitization.expand_composite_and_allocate_qubits(circuit, decompose=decompose_func),
        """
                                     ┌─────┐                                 ┌─────┐                                     ┌─────┐                                 ┌─────┐
(0, 0): ───────X───QROM_0───swap_0────@────────swap_0──────QROM_0───swap_0────@────────swap_0──────X───QROM_0───swap_0────@────────swap_0──────QROM_0───swap_0────@────────swap_0──────
                   │        │         │        │           │        │         │        │               │        │         │        │           │        │         │        │
(0, 1): ───────X───QROM_0───swap_0────┼@───────swap_0──────QROM_0───swap_0────┼@───────swap_0──────X───QROM_0───swap_0────┼@───────swap_0──────QROM_0───swap_0────┼@───────swap_0──────
                   │        │         ││       │           │        │         ││       │               │        │         ││       │           │        │         ││       │
(0, 2): ───────X───QROM_1───swap_0────┼┼@──────swap_0──────QROM_1───swap_0────┼┼@──────swap_0──────X───QROM_1───swap_0────┼┼@──────swap_0──────QROM_1───swap_0────┼┼@──────swap_0──────
                   │        │         │││      │           │        │         │││      │               │        │         │││      │           │        │         │││      │
(0, 3): ───────X───QROM_1───swap_0────┼┼┼@─────swap_0──────QROM_1───swap_0────┼┼┼@─────swap_0──────X───QROM_1───swap_0────┼┼┼@─────swap_0──────QROM_1───swap_0────┼┼┼@─────swap_0──────
                   │        │         ││││     │           │        │         ││││     │               │        │         ││││     │           │        │         ││││     │
ancilla_0: ────────QROM_1───swap_0────┼┼┼┼@────swap_0──────QROM_1───swap_0────┼┼┼┼@────swap_0──────────QROM_3───swap_1────┼┼┼┼─────swap_1──────QROM_3───swap_1────┼┼┼┼─────swap_1──────
                   │        │         │││││    │           │        │         │││││    │               │        │         ││││     │           │        │         ││││     │
ancilla_1: ────────QROM_2───swap_1────┼┼┼┼┼────swap_1──────QROM_2───swap_1────┼┼┼┼┼────swap_1──────────QROM_1───swap_0────┼┼┼┼@────swap_0──────QROM_1───swap_0────┼┼┼┼@────swap_0──────
                   │        │         │││││    │           │        │         │││││    │               │        │         │││││    │           │        │         │││││    │
ancilla_2: ────────QROM_2───swap_1────┼┼┼┼┼────swap_1──────QROM_2───swap_1────┼┼┼┼┼────swap_1──────────QROM_3───swap_1────┼┼┼┼┼────swap_1──────QROM_3───swap_1────┼┼┼┼┼────swap_1──────
                   │        │         │││││    │           │        │         │││││    │               │        │         │││││    │           │        │         │││││    │
ancilla_3: ────────QROM_3───swap_1────┼┼┼┼┼────swap_1──────QROM_3───swap_1────┼┼┼┼┼────swap_1──────────QROM_2───swap_1────┼┼┼┼┼────swap_1──────QROM_2───swap_1────┼┼┼┼┼────swap_1──────
                   │        │         │││││    │           │        │         │││││    │               │        │         │││││    │           │        │         │││││    │
ancilla_4: ────────QROM_3───swap_1────┼┼┼┼┼────swap_1──────QROM_3───swap_1────┼┼┼┼┼────swap_1──────────QROM_3───swap_1────┼┼┼┼┼────swap_1──────QROM_3───swap_1────┼┼┼┼┼────swap_1──────
                   │        │         │││││    │           │        │         │││││    │               │        │         │││││    │           │        │         │││││    │
ancilla_5: ────────QROM_3───swap_1────┼┼┼┼┼────swap_1──────QROM_3───swap_1────┼┼┼┼┼────swap_1──────────QROM_2───swap_1────┼┼┼┼┼────swap_1──────QROM_2───swap_1────┼┼┼┼┼────swap_1──────
                   │        │         │││││    │           │        │         │││││    │               │        │         │││││    │           │        │         │││││    │
selection0: ───────In───────┼─────────┼┼┼┼┼────┼───────────In───────┼─────────┼┼┼┼┼────┼───────────────In───────┼─────────┼┼┼┼┼────┼───────────In───────┼─────────┼┼┼┼┼────┼───────────
                   │        │         │││││    │           │        │         │││││    │               │        │         │││││    │           │        │         │││││    │
selection1: ───────In───────┼─────────┼┼┼┼┼────┼───────────In^-1────┼─────────┼┼┼┼┼────┼───────────────In───────┼─────────┼┼┼┼┼────┼───────────In^-1────┼─────────┼┼┼┼┼────┼───────────
                            │         │││││    │                    │         │││││    │                        │         │││││    │                    │         │││││    │
selection2: ────────────────@(r⇋0)────┼┼┼┼┼────@(r⇋0)^-1────────────@(r⇋0)────┼┼┼┼┼────@(r⇋0)^-1────────────────@(r⇋0)────┼┼┼┼┼────@(r⇋0)^-1────────────@(r⇋0)────┼┼┼┼┼────@(r⇋0)^-1───
                                      │││││                                   │││││                                       │││││                                   │││││
target00: ────────────────────────────X┼┼┼┼───────────────────────────────────X┼┼┼┼───────────────────────────────────────X┼┼┼┼───────────────────────────────────X┼┼┼┼────────────────
                                       ││││                                    ││││                                        ││││                                    ││││
target01: ─────────────────────────────X┼┼┼────────────────────────────────────X┼┼┼────────────────────────────────────────X┼┼┼────────────────────────────────────X┼┼┼────────────────
                                        │││                                     │││                                         │││                                     │││
target10: ──────────────────────────────X┼┼─────────────────────────────────────X┼┼─────────────────────────────────────────X┼┼─────────────────────────────────────X┼┼────────────────
                                         ││                                      ││                                          ││                                      ││
target11: ───────────────────────────────X┼──────────────────────────────────────X┼──────────────────────────────────────────X┼──────────────────────────────────────X┼────────────────
                                          │                                       │                                           │                                       │
target12: ────────────────────────────────X───────────────────────────────────────X───────────────────────────────────────────X───────────────────────────────────────X────────────────
                                     └─────┘                                 └─────┘                                     └─────┘                                 └─────┘
""",
    )
